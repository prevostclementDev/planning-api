on:
  push:
    branch:
      - develop

name: ðŸš€ Deploy with test

jobs:
  phpunit-test:
    name: Starting PHPUNIT test
    runs-on: ubuntu-latest

    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      - name: Composer update
        uses: php-actions/composer@v6
        with:
          dev: no
          args: --profile --ignore-platform-reqs

      - name: Phpunit start
        run : composer test

  deploy-on-vps:
    name: SSH Upload
    runs-on: ubuntu-latest
    needs: phpunit-test
    steps:
      - name: install ssh keys
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts

      - name: Connexion and create fake directory
        run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} " mkdir test "

      - name: clean
        run: rm -rf ~/.ssh
